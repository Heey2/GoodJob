package com.goodjob;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.URL;
import java.util.ArrayList;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;

import com.goodjob.test.TestDAO;

public class SearchInfo {
	public static void main(String[] args) {
		// searchCompanyInfo();
		searchHireInfo();
	}

	private static void searchHireInfo() {
		TestDAO dao = new TestDAO();

		ArrayList<Company> list = dao.comList();
		// e11f4c31b1b2d90885677aedb28703686d37aecc
		for (Company com : list) {

			String path = "https://opendart.fss.or.kr/api/empSttus.json?crtfc_key=e11f4c31b1b2d90885677aedb28703686d37aecc&corp_code="+com.getCode()+"&bsns_year=2023&reprt_code=11011";
			try {
				URL url = new URL(path);

				// JSON 결과
				BufferedReader bf;
				bf = new BufferedReader(new InputStreamReader(url.openStream(), "UTF-8"));
				String result = bf.readLine();
				bf.close();

				JSONParser parser = new JSONParser();
				JSONObject root = (JSONObject) parser.parse(result);
				String maleNum = "";
				String maleYear = "";
				String maleSalary = "";
				
				String femaleNum = "";
				String femaleYear = "";
				String femaleSalary = "";
				if(((String)((JSONObject) root).get("status")).equals("000")) {
					
					JSONArray arr = (JSONArray) root.get("list");
					for (Object info : arr) {
						if(((String)((JSONObject) info).get("sexdstn")).equals("남")) {
							
							maleNum =((String) ((JSONObject) info).get("sm"));
							maleYear =((String) ((JSONObject) info).get("avrg_cnwk_sdytrn"));
							int months = convertToMonths(maleYear);
							maleSalary =((String) ((JSONObject) info).get("fyer_salary_totamt"));
							System.out.printf("%s(남): %s, %d개월, %s\r\n", com.getName(), maleNum, months, maleSalary);
							
						} else if(((String)((JSONObject) info).get("sexdstn")).equals("여")) {
							femaleNum =((String) ((JSONObject) info).get("sm"));
							femaleYear =((String) ((JSONObject) info).get("avrg_cnwk_sdytrn"));
							femaleSalary =((String) ((JSONObject) info).get("fyer_salary_totamt"));
							System.out.printf("%s(여): %s, %s, %s\r\n", com.getName(), femaleNum, femaleYear, femaleSalary);
						}
						
					}
				}
				

				/*
				 * System.out.println(com.getName()); System.out.println(com.getEst_dt());
				 * System.out.println(com.getCeo_nm()); break;
				 * 
				 * &&(((String)((JSONObject) info).get("fo_bbm")).equals("전사")
										||((String)((JSONObject) info).get("fo_bbm")).equals("성별합계"))
				 */

				/*
				 * int end = dao.updateInfo(com); System.out.println(end);
				 */
			} catch (Exception e) {
				System.out.println("emain");
				e.printStackTrace();
			}
		}

	}

	private static void searchCompanyInfo() {
		TestDAO dao = new TestDAO();

		ArrayList<Company> list = dao.comList();
		// e11f4c31b1b2d90885677aedb28703686d37aecc
		for (Company com : list) {
			// https://opendart.fss.or.kr/api/company.json?crtfc_key=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&corp_code=00126380
			String path = "https://opendart.fss.or.kr/api/company.json?crtfc_key=e11f4c31b1b2d90885677aedb28703686d37aecc&corp_code="
					+ com.getCode();
			try {
				URL url = new URL(path);

				// JSON 결과
				BufferedReader bf;
				bf = new BufferedReader(new InputStreamReader(url.openStream(), "UTF-8"));
				String result = bf.readLine();
				bf.close();

				JSONParser parser = new JSONParser();
				JSONObject info = (JSONObject) parser.parse(result);

				com.setEst_dt((String) ((JSONObject) info).get("est_dt"));
				com.setCeo_nm((String) ((JSONObject) info).get("ceo_nm"));

				System.out.println(com.getName());
				System.out.println(com.getEst_dt());
				System.out.println(com.getCeo_nm());
				// break;

				int end = dao.updateInfo(com);
				System.out.println(end);
			} catch (Exception e) {
				System.out.println("emain");
				e.printStackTrace();
			}
		}
	}
	
	public static int convertToMonths(String date) {
        date = date.replace(" ", "");  // 공백 제거
        int years = 0;
        int months = 0;

        if (date.contains("년")) {
            String[] parts = date.split("년");
            years = Integer.parseInt(parts[0]);
            if (parts.length > 1 && parts[1].contains("개월")) {
                months = Integer.parseInt(parts[1].replace("개월", ""));
            }
        } else if (date.contains("개월")) {
            months = Integer.parseInt(date.replace("개월", ""));
        } else {
            years = (int) Double.parseDouble(date);
        }

        return years * 12 + months;
    }
}	

